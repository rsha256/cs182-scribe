<!DOCTYPE html>
<html>
<head>
    <title>My First Web Page</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>My First Web Page</h1>
    <p>My first paragraph.</p>
    <!-- Show PDF from `pdf` variable -->
    <a id="ascribe" href="" target="search_iframe">Bing</a>
    <iframe id="scribe" name="search_iframe" width="100%" height="100%"></iframe>
    <script src='https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.js'></script>
<script src='https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js'></script>
    <script type="text/javascript">
function downloadBuffer({ buffer, fileName }) {
  // Create an invisible A element
  const a = document.createElement('a');
  a.style.display = 'none';
  document.body.appendChild(a);

  // Set the HREF to a Blob representation of the buffer to be downloaded
  a.href = window.URL.createObjectURL(
    new Blob([buffer]),
  );
  // Use download attribute to set set desired file name
  a.setAttribute('download', fileName);

  // Trigger the download by simulating click
  a.click();

  // Cleanup
  window.URL.revokeObjectURL(a.href);
  document.body.removeChild(a);
}

/**
 * @param {_Readable} readable
 */
async function readableToBuffer(readable) {
  const chunks = [];
  for await (const chunk of readable) {
    chunks.push(chunk);
  }
  return Buffer.concat(chunks);
}

async function mergePdfs(inputUrls, outputFileName = 'merged.pdf') {
  const doc = await PDFLib.PDFDocument.create();
  const start = Date.now();

  console.log('dowloading pdfs..');
  const inputFiles = await Promise.all(
    inputUrls
      .map(async (url) => {
        const res = await fetch(url).then( response => response.json() )
   .then( data => console.log(data) );
        return res.arrayBuffer();
      }),
  );


  inputFiles.forEach((inputFileBuffer) => {
    console.log('adding pdf..');
    const ext = new pdf.ExternalDocument(inputFileBuffer);
    doc.setTemplate(ext);
    doc.addPagesOf(ext);
  });
  doc.end();

  // download
  console.log('gathering chunks..');
  // @ts-ignore
  const buffer = await readableToBuffer(doc);
  console.log('preparing download..');
  downloadBuffer({
    buffer,
    fileName: outputFileName,
  });
  console.log('Time taken = ', Date.now() - start);
}

// @ts-ignore
window.mergePdfs = mergePdfs;

        var urls = [];
        for (var i = 2; i < 28; ++i) {
            urls.push("https://inst.eecs.berkeley.edu/~cs182/fa22/assets/notes/scribe" + i + ".pdf");
            // console.log if there is a valid PDF at the URL
        }

        window.mergePdfs(urls);
    </script>
</body>
<script src='https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.js'></script>
<script src='https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js'></script>
</html>
